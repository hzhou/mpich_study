subcode: test_mymake_config
    $global %config_hash
    $global @mpich_config, @testmpi_config
    $call parse_config
    $call parse_trigger_phrase
    $call @set_missing_default
    $call filter_config

    subcode: parse_config
        my $config = $ENV{config}
        $print parsing config: [$config]...
        $config=~s/[\/-]/:/g
        $if $config=~/^(default|ch3:tcp)/
            NOOP
        $elif $config=~/^ch[34]/
            push @mpich_config, "--with-device=$config"

    subcode: parse_trigger_phrase
        my $trigger_phrase = $ENV{ghprbCommentBody}
        $trigger_phrase=~s/\\r\\n/\n/g
        $trigger_phrase=~s/\n\s*:/ /g

        $call check_test_script
        $call check_mpich_config

        $if $trigger_phrase=~/^\s*(compiler|skip_test|out_of_tree)\s*[:=]\s*([\w\-\.]+)/m -> $key, $val
            $if $val=~/(yes|1)/
                $val = "true"
            $ENV{$key}=$val

        $while $trigger_phrase=~/^env:\s*(\w+)\s*=\s*(.*?)\s*$/mg
            $ENV{$1}=$2

        $if !$ENV{skip_test}
            $call check_custom_testlist

        # ------------------------
        subcode: check_test_script
            my %h_script = ("quick"=>"test_quick", "mpich"=>"test_build")
            $if $trigger_phrase=~/^test_script\s*[:=]\s*(\w+)/m && $h_script{$1}
                $ENV{test_script}=$h_script{$1}

        subcode: check_mpich_config
            my $t = $ENV{configOption}."\n".$trigger_phrase
            $print parsing trigger phrase: \n   [$t]...
            $while $t=~/(--(enable|disable|with|without)-\S+)/g
                push @mpich_config, $1

        subcode: check_custom_testlist
            $global @testlist
            $while $trigger_phrase=~/^testlist:\s*(.+)/mg
                $print testlist [$1]
                push @testlist, $1
            $if @testlist
                &call open_W, test/mpi/testlist.custom
                    $foreach $l in @testlist
                        $print $l
                $ENV{skip_test}="custom"

    #---------------------------------------- 
    subcode: set_missing_default
        my $test_script = $ENV{test_script}
        $if !$test_script
            $(if:0)
                $test_script = "test_quick"
            $(else)
                $test_script = "test_build"

        $if !$ENV{compiler}
            $ENV{compiler}='gnu'

    #---------------------------------------- 
    subcode: filter_config
        # FIXME: temporary measure...
        $if $ENV{test_script} eq "test_quick"
            # push @mpich_config, "--disable-cxx"
            # push @mpich_config, "--disable-fortran"
            # push @mpich_config, "--disable-romio"

        my @config_devices
        $if @mpich_config
            $foreach $t in @mpich_config
                $if $t=~/--with-device=(.*)/
                    push @config_devices, $1
                $call filter_config_hash # remove duplicate
                $call filter_test_config

        $call @post_filters

        $if @mpich_config
            $ENV{mpich_config}= join(' ', @mpich_config)
        $if @testmpi_config
            $ENV{testmpi_config} = join(' ', @testmpi_config)

        $if $config_hash{device}=~/^(ch\d:\w+)/
            # for xfail filters
            $ENV{mpich_device}=$1

        $if $config=~/(ch\d+:\w+)/ -> $t
            $foreach $dev in @config_devices
                $if $dev !~ /$t/
                    $config_hash{conflict} = "config: $config and option: --with-device=$dev are in conflict"

        $if $config=~/(ch3:\w+)/ -> $t
            $if $config_hash{pmix}
                $config_hash{conflict} = "config: $config and option: --with-pmix=$config_hash{pmix} are in conflict"

        # ----------------------
        subcode: filter_config_hash
            my $k=$t
            $k=~s/=.*$//
            $k=~s/^--(disable|enable|with|without)-//
            $if $config_hash{$k}
                $t=''
                next
            $if $t=~/=(.+)/
                $config_hash{$k}=$1
            $else
                $config_hash{$k}=1

        subcode: filter_test_config
            $if $t=~/--(disable|enable)-(.*-tests)/
                push @testmpi_config, $t
                $t=''
                next
            $elif $t=~/--disable-(romio|fortran|cxx)/
                push @testmpi_config, $t

        subcode: post_filters
            push @testmpi_config, "--disable-perftest"

            $if $config_hash{pmix} or $config_hash{device}=~/ucx/ or $config_hash{pmi}=~/pmi2/
                push @testmpi_config, "--disable-spawn"

            $if $config_hash{device}!~/ch3:tcp/
                push @testmpi_config, "--disable-ft-tests"

            $if $config_hash{device}=~/ch3:sock/
                push @testmpi_config, "--disable-comm-overlap-tests"

            $if $config_hash{pm} eq "gforker"
                $if !$config_hash{namepublisher}
                    push @mpich_config, "--with-namepublisher=file"
                $else
                    $config_hash{conflict} = "Conflicting config option: --with-pm=gforker and --with-namepublisher=$config_hash{namepublisher}"

