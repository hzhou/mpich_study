macros:
    Dmpl_hydra: ../../../src/mpl
    Impl_hydra: $(Dmpl_hydra)/include
    Lmpl_hydra: $(Dmpl_hydra)/libmpl.la
    Hmpl_hydra: $(Impl)/mplconfig.h

#---- mymake_hydra.pl -------------------- 
subcode: prepare_hydra
    $if $srcdir
        my $dir="$srcdir/src/pm/hydra"
        chdir $dir or die "Can't chdir $dir\n"
    $if !-d "mymake"
        mkdir "mymake" or die "can't mkdir mymake\n"
    $if !-f "mymake/Makefile.orig"
        $call hydra_config

    my $bin="\x24(PREFIX)/bin"
    $dst_hash{"LN_S-$bin/mpiexec"}="$bin/mpiexec.hydra"
    $dst_hash{"LN_S-$bin/mpirun"}="$bin/mpiexec.hydra"

    $call need_mpl
    $call need_hwloc
    $call custom_make

    subcode: dump_variable_custom
        $call @filter_var_hwloc
        $(if:key=AM_CPPFLAGS)
            $t=~s/\s*-I\S*mpl\/include//g
            $t .= $I_list

    subcode: set_libs_custom
        $t=~s/\s*\S*\/libmpl.la//g
        $t=~s/-lhydra/libhydra.la/g
        $t=~s/-lpm/libpm.la/g
        $t .= $L_list

# -------------------
subcode: hydra_config
    $if $srcdir
        my $o="../../.."
        system "rsync -r $o/confdb/ confdb/" 
        system "cp $o/maint/version.m4 ."
    $else
        $if !-d "confdb" 
            die "hydra: missing confdb/\n"
        $if !-f "version.m4"
            die "hydra: missing version.m4\n"

    &call modify_frame, temporary
        &call modify, configure.ac
            $if $l=~/^\s*hwloc\)/
                print Out $l
                $flag_skip=1
                next
            $elif $flag_skip && $l=~/AC_MSG_RESULT/
                $flag_skip=2
            $elif $flag_skip==2 && $l=~/^(\s*)if test.*\$have_hwloc.*then/
                print Out $1, "have_hwloc=yes\n"
                print Out $1, "hydra_use_embedded_hwloc=no\n" # we handles it
                $flag_skip=0
            $elif $l=~/^(HWLOC_DO_AM_CONDITIONALS)/
                $l = "\x23 $1\n"
            $elif $l=~/^(\s*)(PAC_CONFIG_SUBDIR.*)/ # mpl
                $l = "$1: \x23 $2\n"
            $elif $l=~/^(\s*)PAC_SUBDIR_HWLOC/
                $l = $1."AM_CONDITIONAL([HAVE_HWLOC], [true])\n"
                $flag_skip=0
        &call modify, Makefile.am
            $if $l=~/ACLOCAL_AMFLAGS/
                $l ="ACLOCAL_AMFLAGS = -I confdb\n"
        &call modify, tools/topo/hwloc/Makefile.mk
            $if $l=~/if\s+HYDRA_USE_EMBEDDED_HWLOC/i
                $flag_skip=1
                next
            $elif $l=~/endif/
                $flag_skip=0
                next
        system "autoreconf -ivf"
    system "rm -f Makefile"
    system "./configure"
    &call modify_frame, temporary
        $call patch_libtool
    system "mv Makefile mymake/Makefile.orig"

#---- rules in mpich Makefile ------------------ 
subcode: add_rule_hydra
    my $mkfile="src/pm/hydra/Makefile"
    my $add="$(Lmpl) $(Lhwloc)"
    push @extra_make_rules, ".PHONY: hydra hydra-install"
    push @extra_make_rules, "hydra: $mkfile $add"
    push @extra_make_rules, "\t(cd src/pm/hydra && \x24(MAKE) )"
    push @extra_make_rules, ""
    push @extra_make_rules, "hydra-install: $mkfile"
    push @extra_make_rules, "\t(cd src/pm/hydra && \x24(MAKE) install )"
    push @extra_make_rules, ""
    push @extra_make_rules, "$mkfile:"
    push @extra_make_rules, "\t\x24(DO_hydra) --prefix=\x24(PREFIX)"
    push @extra_make_rules, ""

