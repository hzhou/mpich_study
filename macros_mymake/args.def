subcode: _autoload
    my $pwd=`pwd`
    chomp $pwd

#- findout mymake directory
subcode: set_mymake
    my $mymake
    $if $0=~/^(\/.*)\//
        $mymake = $1
    $elif $0=~/^(.*)\//
        $mymake .= "$pwd/$1"
    $mymake .="/mymake"

#- cmdline, sort out options 
subcode: parse_args
    $global %opts
    $global @config_args
    $call @set_opts_default
    $if @ARGV == 1 && $ARGV[0] eq "V=1"
        $opts{V} = 1
        @ARGV=()
    $call @load_last_ARGV
    $call parse_ARGV
    $map opt_set, srcdir, moddir, prefix
    $call set_prefix
    $call set_moddir
    $call probe_srcdir

    subcode: set_moddir
        my $mod_tarball
        $if $ENV{MODTARBALL}
            $mod_tarball = $ENV{MODTARBALL}
        $elif -e "modules.tar.gz"
            $mod_tarball = "modules.tar.gz"
        $elif -e "mymake/modules.tar.gz"
            $mod_tarball = "mymake/modules.tar.gz"
        # --------------
        $if $ENV{MODDIR}
            $moddir = $ENV{MODDIR}
        $elif -d "mymake/hwloc"
            $moddir = "$pwd/mymake"
        $elif -e $mod_tarball
            $moddir = "$pwd/mymake"
            $call do_cmd, mkdir -p $moddir
            $call do_cmd, tar -C $moddir -xf $mod_tarball
        $else
            die "moddir not set\n"

    subcode: probe_srcdir
        NOOP
        $(for:.,..,../..,../../..)
            $case -f "$1/maint/version.m4"
                $srcdir = "$1"
        $if !$srcdir
            die "srcdir not set\n"

    subcode: set_prefix
        $if !$prefix
            $prefix="$pwd/_inst"
            system "mkdir -p $prefix"

    subcode: opt_set(name)
        $global $$(name)
        $if $opts{$(name)}
            $$(name) = $opts{$(name)}

    subcode: set_opts_default
        $opts{V}=0
        $opts{ucx}="embedded"
        $opts{libfabric}="embedded"

    subcode: parse_ARGV
        $foreach $a in @ARGV
            $if $a=~/^--(prefix)=(.*)/
                $opts{$1}=$2
            $elif $a=~/^(\w+)=(.*)/
                $opts{$1}=$2
            $elif $a=~/^--/
                $if $a=~/^--with-device=(.*)/
                    $opts{device}=$1
                    push @config_args, $a
                $elif $a=~/^--with-pm=(.*)/
                    $opts{pm}=$1
                    # push @config_args, $a
                $elif $a=~/--disable-(romio|cxx|fortran)/
                    $opts{"disable_$1"}=1
                    $opts{"enable_$1"}=0
                    push @config_args, $a
                $elif $a=~/--enable-fortran=(\w+)/
                    $opts{disable_fortran}=0
                    $opts{enable_fortran}=$1
                    push @config_args, $a
                $elif $a=~/--with-atomic-primitives=(.*)/
                    $opts{openpa_primitives} = $1
                $elif $a=~/--enable-strict/
                    $opts{enable_strict} = 1
                    push @config_args, $a
                $elif $a=~/--with-(ucx|libfabric|argobots)=(.*)/
                    $opts{$1}=$2
                    push @config_args, $a
                $else
                    push @config_args, $a
            $elif $a=~/^(clean|errmsg|cvars|logs|hydra|testing)$/
                $opts{do}=$1

        $(for:CC,CXX,F77,FC)
            $if $opts{$1}
                $ENV{$1}=$opts{$1}

#----------------------
subcode: load_last_ARGV
    my $need_save_args
    $if !@ARGV && -f "mymake/args"
        $call get_file_in_t, mymake/args
        chomp $t
        @ARGV = split /\s+/, $t
        $print loading last ARGV: @ARGV
    $elif @ARGV
        # has to wait until mymake folder is made
        $need_save_args = 1

subcode: save_last_ARGV
    $if $need_save_args
        my $t = join(' ', @ARGV)
        &call open_w, mymake/args
            print Out $t, "\n"
        system "rm -f mymake/Makefile.orig"
        system "rm -f $(Hmpl) $(Hopa)"

