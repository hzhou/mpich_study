subcode: compile_mpich
    $call mpich_configure
    $call @check_mpichconf_h
    $call custom_make
    $(if:do_make)
        system "make -j$(do_make)"

    # ---------------------------
    subcode: dump_variable_custom
        $(if:key=AM_CPPFLAGS)
            $t=~s/\@HWLOC_\S+\@\s*//
        $(elif:key=CPPFLAGS)
            $t=~s/^-I.*\/(mpl|openpa)\/\S+\s*//g
            $t.=" -I$(Impl) -I$(Iopa) -I$(Ihwloc)"
        $(elif:key=AM_CFLAGS)
            $t=~s/\@HWLOC_\S+\@\s*//

    subcode: set_libs_custom
        $(if:which=ltlibs)
            $t=~s/\bsrc\/(mpl|openpa)\/\S+\s*//g
            $t.=" $(Lmpl) $(Lopa) $(Lhwloc)"

#---------------------------------------- 
subcode: mpich_configure
    push @realclean_list, "subsys_include.m4"
    push @realclean_list, "configure"
    push @realclean_list, "mymake/Makefile.orig"
    push @realclean_list, "src/pm/hydra/mymake/Makefile.orig"
    $if !-f "subsys_include.m4"
        system "perl maint/gen_subcfg_m4"
    $if !-f "configure"
        &call temporary_modify
            $call modify_configure_ac
            system "autoreconf -ivf"
    $if !-f "mymake/Makefile.orig"
        system "rm -f Makefile"
        my $t = join ' ', @config_args
        system "./configure --disable-cxx --disable-fortran --disable-romio --with-pm=none $t"
        system "mv Makefile mymake/Makefile.orig"

    # -------------------
    subcode: modify_configure_ac
        &call modify, configure.ac
            $if $l=~/AC_CONFIG_SUBDIRS/
                next
            $elif $l=~/^\s*HWLOC_/
                next
            $elif $l=~/^\s*src\/binding\//
                next
            $elif $l=~/^(\s*)(PAC_CONFIG_SUBDIR.*)/
                $l = "$1: \x23 $2\n"
        &call modify, src/Makefile.mk
            $if $l=~/^include .*\/binding\//
                next
        &call modify, Makefile.am
            $if $l=~/ACLOCAL_AMFLAGS/
                $l ="ACLOCAL_AMFLAGS = -I confdb\n"
        my $flag
        &call modify, src/mpid/ch3/subconfigure.m4
            $if $l=~/AC_MSG_CHECKING.*OpenPA/
                $flag=1
            $elif $flag and $l=~/AC_C_BIGENDIAN/
                $flag=0
            $elif $flag
                next

# --------------------
subcode: check_mpichconf_h
    &call open_r, "src/include/mpichconf.h"
        $if /^#define\s+HAVE_.*WEAK.* 1/
            $opts{have_weak}=1
    &call open_r, "maint/version.m4"
        $if /libmpi_so_version_m4.*\[([\d:]*)\]/
            $opts{so_version}=$1

    $if !$opts{have_weak}
        $special_targets{lib_libmpi_la}="\x24(LTCC) -DMPICH_MPI_FROM_PMPI"


#-------------------------
subcode: fortran_buildiface
    chdir "src/binding/fortran/mpif_h"
    system "perl buildiface"
    chdir $srcdir

subcode: romio_glue_code
    chdir "src/glue/romio"
    system "perl all_romio_symbols ../../mpi/romio/include/mpio.h.in"
    chdir "../../.."

