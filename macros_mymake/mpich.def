subcode: compile_mpich
    $call mpich_configure
    $call @post_mpich_configure

    $call add_rule_cpi

    $call need_mpich_preproc
    $(for:mpl,opa,hwloc,romio)
        $call need_$1
    $if $opts{device}=~/ucx/
        $call need_ucx
    $if $opts{device}=~/ofi/
        $call need_ofi
    $call custom_make

    # ---------------------------
    subcode: dump_variable_custom
        $call filter_var_hwloc
        $(if:key=CPPFLAGS)
            $call filter_var_mpl_etc
            $t .= $I_list

    subcode: set_libs_custom
        $(if:which=ltlibs)
            $call filter_lib_mpl_etc
            $call filter_lib_ucx
            $call filter_lib_ofi
            $t.= $L_list
    # ---------------------------
    subcode: post_mpich_configure
        &call open_r, src/include/mpichconf.h
            $if /^#define\s+HAVE_.*WEAK.* 1/
                $opts{have_weak}=1
        &call open_r, maint/version.m4
            $if /libmpi_so_version_m4.*\[([\d:]*)\]/
                $opts{so_version}=$1
        &call open_r, config.status
            $if /S\["WRAPPER_LIBS"\]="(.*)"/
                $opts{WRAPPER_LIBS}=$1

        $if !$opts{have_weak}
            $special_targets{lib_libmpi_la}="\x24(LTCC) -DMPICH_MPI_FROM_PMPI"

        my $bin="\x24(PREFIX)/bin"
        $(for:p in mpicc,mpicxx,mpif77,mpifort)
            $if -f "src/env/$(p).bash"
                $call get_file_lines, src/env/$(p).bash
                my %tmp=(PREFIX=>$prefix, EXEC_PREFIX=>"$prefix/bin", SYSCONFDIR=>"$prefix/etc", INCLUDEDIR=>"$prefix/include", LIBDIR=>"$prefix/lib")
                &call open_w, mymake/$(p)
                    $foreach $l in @lines
                        $l=~s/__(\w+)_TO_BE_FILLED_AT_INSTALL_TIME__/$tmp{$1}/e
                        print Out $l
                $dst_hash{"mymake/$(p)"}=$bin
        $dst_hash{"LN_S-$bin/mpic++"}="$bin/mpicxx"
        $dst_hash{"LN_S-$bin/mpif90"}="$bin/mpifort"

    # --------------------
    subcode: add_rule_cpi
        push @extra_make_rules, "examples/cpi: lib/libmpi.la"
        push @extra_make_rules, "\t\x24(CC) -o examples/cpi examples/cpi.c lib/.libs/libmpi.a $opts{WRAPPER_LIBS}"
        push @extra_make_rules, ""
        
#---------------------------------------- 
macros:
    mpich_configure_deps:: subsys_include.m4
    mpich_configure_deps:: configure
    mpich_configure_deps:: Makefile
    mpich_configure_deps:: mymake/Makefile.*

subcode: mpich_configure
    $if !-f "subsys_include.m4"
        $call stage, maint/gen_subcfg_m4
        system "perl maint/gen_subcfg_m4"
    $if !-f "configure"
        system "rm -f mymake/Makefile.orig"
        $call stage, Autoconf MPICH
        &call temporary_modify
            $call modify_configure_ac
            system "autoreconf -ivf"
    $if !-f "mymake/Makefile.orig"
        $call stage, Configure MPICH
        system "rm -f Makefile"
        my $t = join ' ', @config_args
        system "./configure --with-pm=no $t" # we'll configure/build hydra separately
        system "mv Makefile mymake/Makefile.orig"
        &call temporary_modify
            $call patch_libtool

    # -------------------
    subcode: modify_configure_ac
        &call modify, configure.ac
            $if $l=~/AC_CONFIG_SUBDIRS/
                next
            $elif $l=~/^\s*HWLOC_/
                next
            $elif $l=~/^\s*src\/binding\//
                next
            $elif $l=~/^(\s*)(PAC_CONFIG_SUBDIR.*)/
                $l = "$1: \x23 $2\n"
        &call modify, src/Makefile.mk
            $if $l=~/^include .*\/binding\//
                next
        &call modify, Makefile.am
            $if $l=~/ACLOCAL_AMFLAGS/
                $l ="ACLOCAL_AMFLAGS = -I confdb\n"
        my $flag
        &call modify, src/mpid/ch3/subconfigure.m4
            $if $l=~/AC_MSG_CHECKING.*OpenPA/
                $flag=1
            $elif $flag and $l=~/AC_C_BIGENDIAN/
                $flag=0
            $elif $flag
                next
        $if $opts{device}=~/ucx/
            $call patch_configure_ucx
        $if $opts{device}=~/ofi/
            $call patch_configure_ofi

subcode: need_mpich_preproc
    $(set:errhan=src/mpi/errhan/$1)
    push @extra_make_rules, "$(errhan:errutil.lo): $(errhan:defmsg.h)"
    $call push_autogen_rule, errmsg, src/mpi/errhan/defmsg.h
    push @CONFIGS, "src/include/mpir_cvars.h"
    $call push_autogen_rule, cvars, src/include/mpir_cvars.h
    # $call push_autogen_rule, logs, src/include/mpiallstates.h

    &call add_subdir_rule_block, src/glue/romio, src/glue/romio/all_romio_symbols.c
        push @t, "perl all_romio_symbols ../../mpi/romio/include/mpio.h.in"

#-------------------------
subcode: fortran_buildiface
    chdir "src/binding/fortran/mpif_h"
    system "perl buildiface"
    chdir $srcdir

subcode: romio_glue_code
    chdir "src/glue/romio"
    system "perl all_romio_symbols ../../mpi/romio/include/mpio.h.in"
    chdir "../../.."

