include: macros/patch.def
page: t, patch_frame
    module: perl
    patch: ERRPOP

#---------------------------------------- 
subcode: grep_ERRPOP
    $(if:1)
        $call grep_l, 'MPIR_ERR_POP'
    $(else)
        # my @files=("src/mpid/ch4/src/ch4_init.h")
        my @files=("src/mpid/ch3/src/mpid_rma.c")
        # my @files=("src/mpi/coll/reduce_scatter/reduce_scatter.c")

subcode: filter_lines_ERRPOP
    $(set:cond=if\s*\((?:mpi_errno|mpi_errno\s*!=\s*MPI_SUCCESS|MPI_SUCCESS\s*!=\s*mpi_errno)\))
    # FIXME: exclude if followed by and else
    $if $(l)=~/^.*MPIR_ERR_POP\(mpi_errno\);$/
        my $call = "MPIR_ERR_CHECK(mpi_errno);"
        $call 
        $if $(l)=~/^(\s*)$(cond)\s*MPIR_ERR_POP.*/
            my $sp = $1
            $(l)= "$sp$call\n"
            $cnt++
        $elif $(l)=~/^(\s*)$(cond)\s*{\s*(MPIR_ERR_POP.*?)\s*}$/
            my $sp = $1
            $(l)= "$sp$call\n"
            $cnt++
        $elif $(L:-1)=~/^(\s*)$(cond)\s*$/
            my $sp = $1
            $(l)= "$sp$call\n"
            $(L:-1) = "-DELETE"
            $cnt++
        $elif $(L:-1)=~/^(\s*)$(cond)\s*{$/ and $(L:1)=~/^(\s*)}$/
            my $sp = $1
            $(l)= "$sp$call\n"
            $(L:-1) = "-DELETE"
            $(L:1)  = "-DELETE"
            $cnt++
        $else
            $print Strange pattern (in $f:$i):
            $print $(L:-1)-
            $print $(l)-

