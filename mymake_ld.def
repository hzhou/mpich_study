output_dir: ./mymake

page: mymake_ld
    my (@args, %info)
    $call parse_args

    $if $info{libname} !~ /libmpi/
        my $cmd = "./libtool --mode=link --quiet"
        $cmd .= " $info{CC}"
        $if $info{libname}
            $cmd .= " -o $info{libname}.la"
        $if $info{rpath}
            $cmd .= " -rpath $info{rpath}"
        $if $info{so_version}
            $cmd .= " -version-info $info{so_version}"
        $cmd .= " " . join(' ', @args)
        system $cmd
    $else
        my $cmd = "$info{CC}"
        my ($name1, $name2, $name3)
        $if $info{libname}=~/(.*)\/(\w+)/
            $name1 = "$2.so.$info{so_version}"
            $name2 = "$2.so.$info{so_name}"
            $name3 = "$2.so"
            $cmd .= " -shared"
            $cmd .= " -o $1/.libs/$name1"
        $foreach $a in @args
            $if $a=~/(.*)\/(\S+)\.lo$/
                $cmd .= " $1/.libs/$2.o"
            $elif $a=~/(.*)\/(\S+)\.la$/
                $cmd .= " -Wl,--whole-archive"
                $cmd .= " $1/.libs/$2.a"
                $cmd .= " -Wl,--no-whole-archive"
            $else
                $cmd .= " $a"
        $cmd .= " -Wl,-soname -Wl,$name2"
        system $cmd
        &call open_W, $info{libname}.la
            $print "library_names='$name1 $name2 $name3'"

    subcode: parse_args
        my $opt
        $foreach $a in @ARGV
            $if $opt
                $opt .= " $a"
            $else
                $opt = $a

            $if $opt=~/^-(o|rpath|version-info)$/
                next
            $elif $opt=~/^gcc/
                $info{CC}=$opt
            $elif $opt=~/^-o (.*)\.la$/
                $info{libname} = $1
            $elif $opt=~/^-rpath (.*)$/
                $info{rpath} = $1
            $elif $opt=~/^-version-info (\d+):(\d+):(\d+)$/
                my $major = $1 - $3
                my $minor = $3
                my $revision = $2
                $info{so_version} = "$major.$minor.$revision"
                $info{so_name} = "$major"
            $else
                push @args, $opt

            undef $opt

page: mymake_install
    $use Cwd
    my ($obj, $dst) = @ARGV
    $if $dst=~/\/lib$/
        $if $obj=~/(.*)\/libmpi.la/ -> $dir
            my ($name1, $name2, $name3)
            &call open_r, $obj
                $if /library_names='(\S+) (\S+) (\S+)'/
                    ($name1, $name2, $name3) = ($1, $2, $3)
            $(if:0)
                system "cp $dir/.libs/$name1 $dst"
            $(else)
                my $cwd = getcwd()
                system "ln -sf $cwd/$dir/.libs/$name1 $dst"
            system "ln -sf $name1 $dst/$name2"
            system "ln -sf $name1 $dst/$name3"
        $else
            system "$(LT_install) $obj $dst"
    $elif $dst=~/\/bin$/
        system "$(LT_install) $obj $dst"
    $elif $dst=~/\/include$/
        system "cp $obj $dst"

    macros: 
        LT_install: ./libtool --mode=install --silent install
